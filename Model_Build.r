{"cells":[{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true,"base_uri":"https://localhost:8080/"},"id":"cV6P30k3hFEj"},"outputs":[{"name":"stderr","output_type":"stream","text":["Installing package into ‘/usr/local/lib/R/site-library’\n","(as ‘lib’ is unspecified)\n","\n","Downloading GitHub repo kuriwaki/ccesMRPprep@HEAD\n","\n"]},{"name":"stdout","output_type":"stream","text":["parallelly (NA -\u003e 1.46.0) [CRAN]\n","listenv    (NA -\u003e 0.10.0) [CRAN]\n","globals    (NA -\u003e 0.18.0) [CRAN]\n","proxy      (NA -\u003e 0.4-28) [CRAN]\n","wk         (NA -\u003e 0.9.4 ) [CRAN]\n","e1071      (NA -\u003e 1.7-16) [CRAN]\n","units      (NA -\u003e 1.0-0 ) [CRAN]\n","s2         (NA -\u003e 1.1.9 ) [CRAN]\n","classInt   (NA -\u003e 0.4-11) [CRAN]\n","sf         (NA -\u003e 1.0-23) [CRAN]\n","future     (NA -\u003e 1.68.0) [CRAN]\n","tigris     (NA -\u003e 2.2.1 ) [CRAN]\n","checkmate  (NA -\u003e 2.3.3 ) [CRAN]\n","furrr      (NA -\u003e 0.3.1 ) [CRAN]\n","tidycensus (NA -\u003e 1.7.3 ) [CRAN]\n","dataverse  (NA -\u003e 0.3.16) [CRAN]\n"]},{"name":"stderr","output_type":"stream","text":["Installing 16 packages: parallelly, listenv, globals, proxy, wk, e1071, units, s2, classInt, sf, future, tigris, checkmate, furrr, tidycensus, dataverse\n","\n","Installing packages into ‘/usr/local/lib/R/site-library’\n","(as ‘lib’ is unspecified)\n","\n"]},{"name":"stdout","output_type":"stream","text":["\u001b[36m──\u001b[39m \u001b[36mR CMD build\u001b[39m \u001b[36m─────────────────────────────────────────────────────────────────\u001b[39m\n","* checking for file ‘/tmp/Rtmp3IduRG/remotes34588d064a/kuriwaki-ccesMRPprep-fefe935/DESCRIPTION’ ... OK\n","* preparing ‘ccesMRPprep’:\n","* checking DESCRIPTION meta-information ... OK\n","* checking for LF line-endings in source and make files and shell scripts\n","* checking for empty or unneeded directories\n","  NB: this package now depends on R (\u003e= 4.1.0)\n","  WARNING: Added dependency on R \u003e= 4.1.0 because package code uses the\n","  pipe |\u003e or function shorthand \\(...) syntax added in R 4.1.0.\n","  File(s) using such syntax:\n","    ‘cd_info_long.Rd’ ‘get_acs-poststrat.R’\n","* building ‘ccesMRPprep_0.1.14.tar.gz’\n","\n"]},{"name":"stderr","output_type":"stream","text":["Installing package into ‘/usr/local/lib/R/site-library’\n","(as ‘lib’ is unspecified)\n","\n","── \u001b[1mAttaching core tidyverse packages\u001b[22m ──────────────────────── tidyverse 2.0.0 ──\n","\u001b[32m✔\u001b[39m \u001b[34mdplyr    \u001b[39m 1.1.4     \u001b[32m✔\u001b[39m \u001b[34mreadr    \u001b[39m 2.1.6\n","\u001b[32m✔\u001b[39m \u001b[34mforcats  \u001b[39m 1.0.1     \u001b[32m✔\u001b[39m \u001b[34mstringr  \u001b[39m 1.6.0\n","\u001b[32m✔\u001b[39m \u001b[34mggplot2  \u001b[39m 4.0.1     \u001b[32m✔\u001b[39m \u001b[34mtibble   \u001b[39m 3.3.0\n","\u001b[32m✔\u001b[39m \u001b[34mlubridate\u001b[39m 1.9.4     \u001b[32m✔\u001b[39m \u001b[34mtidyr    \u001b[39m 1.3.1\n","\u001b[32m✔\u001b[39m \u001b[34mpurrr    \u001b[39m 1.2.0     \n","── \u001b[1mConflicts\u001b[22m ────────────────────────────────────────── tidyverse_conflicts() ──\n","\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mfilter()\u001b[39m masks \u001b[34mstats\u001b[39m::filter()\n","\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mlag()\u001b[39m    masks \u001b[34mstats\u001b[39m::lag()\n","\u001b[36mℹ\u001b[39m Use the conflicted package (\u001b[3m\u001b[34m\u003chttp://conflicted.r-lib.org/\u003e\u001b[39m\u001b[23m) to force all conflicts to become errors\n"]},{"ename":"ERROR","evalue":"Error in library(ccesMRPrun): there is no package called ‘ccesMRPrun’\n","output_type":"error","traceback":["Error in library(ccesMRPrun): there is no package called ‘ccesMRPrun’\nTraceback:\n","1. stop(packageNotFoundError(package, lib.loc, sys.call()))"]}],"source":["install.packages(\"remotes\")\n","library(remotes)\n","\n","remotes::install_github(\"kuriwaki/ccesMRPprep\")\n","library(tidyverse)\n","library(ccesMRPprep)\n","library(ccesMRPrun)\n","install.packages(\"tictoc\")\n","library(tictoc)\n","library(future)\n","\n","install.packages(\"lme4\")\n","library(lme4)\n","library(tictoc)\n","library(tidyverse) # Needed for drop_na"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":1661,"status":"ok","timestamp":1765771237158,"user":{"displayName":"Amanda Huang","userId":"13335420900045939996"},"user_tz":300},"id":"fqDH5G6vhJis","outputId":"20f17e3e-439b-4416-ef0e-348d931b1d90"},"outputs":[{"name":"stderr","output_type":"stream","text":["\u001b[1mRows: \u001b[22m\u001b[34m870\u001b[39m \u001b[1mColumns: \u001b[22m\u001b[34m9\u001b[39m\n","\u001b[36m──\u001b[39m \u001b[1mColumn specification\u001b[22m \u001b[36m────────────────────────────────────────────────────────\u001b[39m\n","\u001b[1mDelimiter:\u001b[22m \",\"\n","\u001b[31mchr\u001b[39m (3): cd, dailykos_name, largest_place\n","\u001b[32mdbl\u001b[39m (6): year, pct_trump, pct_romney, pct_mccain, pct_trump16, totalvoters\n","\n","\u001b[36mℹ\u001b[39m Use `spec()` to retrieve the full column specification for this data.\n","\u001b[36mℹ\u001b[39m Specify the column types or set `show_col_types = FALSE` to quiet this message.\n","\u001b[1mRows: \u001b[22m\u001b[34m870\u001b[39m \u001b[1mColumns: \u001b[22m\u001b[34m7\u001b[39m\n","\u001b[36m──\u001b[39m \u001b[1mColumn specification\u001b[22m \u001b[36m────────────────────────────────────────────────────────\u001b[39m\n","\u001b[1mDelimiter:\u001b[22m \",\"\n","\u001b[31mchr\u001b[39m (1): cd\n","\u001b[32mdbl\u001b[39m (6): year, pct_white_elec, pct_nonwhite_elec, pct_black_elec, pct_hispan...\n","\n","\u001b[36mℹ\u001b[39m Use `spec()` to retrieve the full column specification for this data.\n","\u001b[36mℹ\u001b[39m Specify the column types or set `show_col_types = FALSE` to quiet this message.\n","\u001b[1mRows: \u001b[22m\u001b[34m488\u001b[39m \u001b[1mColumns: \u001b[22m\u001b[34m8\u001b[39m\n","\u001b[36m──\u001b[39m \u001b[1mColumn specification\u001b[22m \u001b[36m────────────────────────────────────────────────────────\u001b[39m\n","\u001b[1mDelimiter:\u001b[22m \",\"\n","\u001b[31mchr\u001b[39m (2): District, Most Prevalent\n","\u001b[32mdbl\u001b[39m (3): Urban %, Suburban %, Rural %\n","\u001b[32mnum\u001b[39m (3): Urban, Suburban, Rural\n","\n","\u001b[36mℹ\u001b[39m Use `spec()` to retrieve the full column specification for this data.\n","\u001b[36mℹ\u001b[39m Specify the column types or set `show_col_types = FALSE` to quiet this message.\n"]}],"source":["\n","# Read in data\n","svy \u003c- read_rds(\"data/ccc_2016-2020_voted_2pty.rds\")\n","cd_elec \u003c- read_csv(\"data/cd_presvote_2016-2020.csv\") |\u003e\n","  select(year, cd, pct_trump)\n","cd_race \u003c- read_csv(\"data/by-cd_pct-race_elec.csv\")\n","urban_class_cd \u003c- read_csv(\"data/rural-urban-sub-classification.csv\")\n","\n","# Cleaned Urban_Classes and joined it\n","urban_class \u003c- urban_class_cd |\u003e\n","  rename(cd = District,\n","         classes = `Most Prevalent`) |\u003e\n","  filter(str_detect(cd, \"-\")) |\u003e\n","  mutate(classes = factor(classes)) |\u003e\n","  select(cd, classes)\n","\n","\n","svy_elec \u003c- svy |\u003e\n","  mutate(\n","    race_Black    = as.integer(race == \"Black\"),\n","    race_Hispanic = as.integer(race == \"Hispanic\"),\n","    race_Other    = as.integer(race == \"Other\"),\n","  ) |\u003e\n","  inner_join(cd_elec, by = c(\"year\", \"cd\")) |\u003e\n","  inner_join(cd_race, by = c(\"year\", \"cd\")) |\u003e\n","  left_join(select(ccesMRPprep::states_key, st, region, division), by = \"st\") |\u003e\n","  left_join(urban_class, by = \"cd\")\n","\n","\n","svy20_elec \u003c- filter(svy_elec, year == 2020)\n","\n","\n","# Original Model by Kuriwaki et al (2023)\n","# Form \u003c- trump  ~ (1 + race * educ + female + age | division / st / cd) +\n","#   race + pct_white_elec +\n","#   race_Black:pct_black_elec + race_Hispanic:pct_hispanic_elec + race_Other:pct_raceother_elec +\n","#   s(pct_trump, k = 3) + classes\n"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":1808333,"status":"ok","timestamp":1765749163306,"user":{"displayName":"Amanda Huang","userId":"13335420900045939996"},"user_tz":300},"id":"IpHEUqg9PJsO","outputId":"383723fe-7126-4859-933f-65e2f181d753"},"outputs":[{"name":"stderr","output_type":"stream","text":["Installing package into ‘/usr/local/lib/R/site-library’\n","(as ‘lib’ is unspecified)\n","\n","Warning message in (function (fn, par, lower = rep.int(-Inf, n), upper = rep.int(Inf, :\n","“failure to converge in 10000 evaluations”\n","Warning message in optwrap(optimizer, devfun, start, rho$lower, control = control, :\n","“convergence code 4 from Nelder_Mead: failure to converge in 10000 evaluations”\n"]},{"name":"stdout","output_type":"stream","text":["857.035 sec elapsed\n"]},{"name":"stderr","output_type":"stream","text":["Warning message in (function (fn, par, lower = rep.int(-Inf, n), upper = rep.int(Inf, :\n","“failure to converge in 10000 evaluations”\n","Warning message in optwrap(optimizer, devfun, start, rho$lower, control = control, :\n","“convergence code 4 from Nelder_Mead: failure to converge in 10000 evaluations”\n"]},{"name":"stdout","output_type":"stream","text":["866.182 sec elapsed\n"]}],"source":["\n","# drop na, set reference\n","svy20_modeling \u003c- svy20_elec |\u003e\n","  drop_na(classes, race, educ, female, age, pct_white_elec) |\u003e\n","  mutate(classes = relevel(factor(classes), ref = \"Rural\"))\n","\n","Form_noUrban \u003c- trump ~ race + educ + female + age +\n","  pct_white_elec +\n","  race_Black:pct_black_elec +\n","  race_Hispanic:pct_hispanic_elec +\n","  race_Other:pct_raceother_elec +\n","  (1 + race | st/cd )\n","\n","Form_withUrban \u003c- trump ~ race + classes +\n","  educ + female + age +\n","  pct_white_elec +\n","  race_Black:pct_black_elec +\n","  race_Hispanic:pct_hispanic_elec +\n","  race_Other:pct_raceother_elec +\n","  (1 + race | st/cd)\n","\n","# takes roughly 1 hour total using High RAM\n","\n","tic()\n","\n","fit_noUrban \u003c- glmer(Form_noUrban, data = svy20_modeling, family = binomial)\n","toc()\n","\n","tic()\n","fit_withUrban \u003c- glmer(Form_withUrban, data = svy20_modeling, family = binomial)\n","toc()\n","\n","\n","saveRDS(fit_noUrban, \"data/glmer_noUrban.rds\")\n","saveRDS(fit_withUrban, \"data/glmer_withUrban.rds\")"]}],"metadata":{"colab":{"authorship_tag":"ABX9TyOGoZSeoUKmPo6zaQ3l/QhQ","name":"","version":""},"kernelspec":{"display_name":"R","name":"ir"},"language_info":{"name":"R"}},"nbformat":4,"nbformat_minor":0}